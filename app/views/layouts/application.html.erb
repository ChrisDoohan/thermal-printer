<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "App" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="App">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>

    <script type="module">
      import hotwiredTurbo from "https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.12/+esm";
    </script>
  </head>

  <body>
    <div id="starfield" data-turbo-permanent></div>
    <%= yield %>
    <div class="container history-container">
      <div class="history-section">
        <div class="history-header">
          <h2>Print History</h2>
          <input type="text" id="history-search" class="history-search" placeholder="Search prints...">
        </div>
        <div id="history-list" class="history-list"></div>
      </div>
    </div>
    <div id="printer-status" class="status-footer" data-turbo-permanent>
      <span class="indicator"></span>
      <span class="status-text">Checking...</span>
      <span class="status-sep">·</span>
      <span id="username-badge" class="username-badge"></span>
    </div>

    <div id="username-modal" class="username-modal" style="display:none">
      <div class="username-modal-box">
        <h2>Who are you?</h2>
        <input type="text" id="username-input" placeholder="Your name" maxlength="30" autocomplete="off">
        <button id="username-save" class="btn btn-primary">Save</button>
      </div>
    </div>
    <script>
      // Generate starfield once — persists across Turbo navigations
      (function() {
        var starfield = document.getElementById('starfield');
        if (starfield.children.length > 0) return;
        for (var i = 0; i < 120; i++) {
          var star = document.createElement('div');
          var isCross = Math.random() < 0.15;
          star.className = isCross ? 'star star-cross' : 'star';
          if (!isCross) {
            var size = Math.random() < 0.85 ? 2 : 3;
            star.style.width = size + 'px';
            star.style.height = size + 'px';
          }
          star.style.left = Math.random() * 100 + '%';
          star.style.top = Math.random() * 100 + '%';
          star.style.setProperty('--duration', (1.5 + Math.random() * 3) + 's');
          star.style.setProperty('--delay', (Math.random() * 4) + 's');
          starfield.appendChild(star);
        }
      })();

      // Shared toast function
      function showToast(message, type) {
        var toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.className = 'toast ' + type + ' show';
        setTimeout(function() { toast.className = 'toast'; }, 1000);
      }

      // Print History
      function timeAgo(dateString) {
        var seconds = Math.floor((new Date() - new Date(dateString)) / 1000);
        if (seconds < 60) return 'just now';
        var minutes = Math.floor(seconds / 60);
        if (minutes < 60) return minutes + 'm ago';
        var hours = Math.floor(minutes / 60);
        if (hours < 24) return hours + 'h ago';
        var days = Math.floor(hours / 24);
        if (days < 30) return days + 'd ago';
        return new Date(dateString).toLocaleDateString();
      }

      function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function buildHistoryEntry(entry) {
        var el = document.createElement('div');
        el.className = 'history-entry';
        el.dataset.contentId = entry.id;
        el.dataset.searchText = ((entry.preview || '') + ' ' + entry.username).toLowerCase();

        var meta = document.createElement('div');
        meta.className = 'history-meta';
        meta.innerHTML = '<span class="history-user">' + escapeHtml(entry.username) + '</span>' +
          '<span class="history-time">' + timeAgo(entry.printed_at) + '</span>';
        el.appendChild(meta);

        var preview = document.createElement('div');
        preview.className = 'history-preview';
        if (entry.content_type === 'image' && entry.thumbnail) {
          var img = document.createElement('img');
          img.src = 'data:image/png;base64,' + entry.thumbnail;
          img.className = 'history-thumbnail';
          preview.appendChild(img);
        } else if (entry.preview) {
          preview.textContent = entry.preview;
        }
        el.appendChild(preview);

        var expanded = document.createElement('div');
        expanded.className = 'history-expanded';
        if (entry.content_type === 'text' && entry.body) {
          var bodyDiv = document.createElement('div');
          bodyDiv.className = 'history-body';
          bodyDiv.innerHTML = entry.body;
          expanded.appendChild(bodyDiv);
        }
        var reprintBtn = document.createElement('button');
        reprintBtn.className = 'btn btn-small history-reprint';
        reprintBtn.textContent = 'Reprint';
        reprintBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          reprintContent(entry.id);
        });
        expanded.appendChild(reprintBtn);
        el.appendChild(expanded);

        el.addEventListener('click', function() {
          el.classList.toggle('open');
        });

        return el;
      }

      function prependHistoryEntry(entry) {
        var list = document.getElementById('history-list');
        if (!list) return;
        var existing = list.querySelector('[data-content-id="' + entry.id + '"]');
        if (existing) existing.remove();
        var el = buildHistoryEntry(entry);
        list.insertBefore(el, list.firstChild);
        var empty = list.querySelector('.history-empty');
        if (empty) empty.remove();
      }

      function reprintContent(contentId) {
        var token = document.querySelector('meta[name="csrf-token"]').content;
        fetch('/reprint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': token },
          body: JSON.stringify({ id: contentId, username: localStorage.getItem('username') || 'anonymous' })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.entry) prependHistoryEntry(data.entry);
          if (data.error) {
            showToast(data.error, 'error');
          } else {
            showToast(data.message, 'success');
          }
        })
        .catch(function() { showToast('Request failed', 'error'); });
      }

      function loadHistory() {
        var list = document.getElementById('history-list');
        if (!list) return;
        fetch('/prints')
          .then(function(r) { return r.json(); })
          .then(function(entries) {
            list.innerHTML = '';
            if (entries.length === 0) {
              list.innerHTML = '<div class="history-empty">Nothing printed yet</div>';
              return;
            }
            entries.forEach(function(entry) {
              list.appendChild(buildHistoryEntry(entry));
            });
          })
          .catch(function() {
            list.innerHTML = '<div class="history-empty">Could not load history</div>';
          });

        var searchInput = document.getElementById('history-search');
        searchInput.addEventListener('input', function() {
          var query = this.value.toLowerCase().trim();
          var entries = document.querySelectorAll('.history-entry');
          entries.forEach(function(el) {
            if (!query || el.dataset.searchText.indexOf(query) !== -1) {
              el.style.display = '';
            } else {
              el.style.display = 'none';
            }
          });
        });
      }

      loadHistory();
      document.addEventListener('turbo:load', loadHistory);

      // Username prompt
      (function() {
        var modal = document.getElementById('username-modal');
        var input = document.getElementById('username-input');
        var saveBtn = document.getElementById('username-save');
        var badge = document.getElementById('username-badge');

        function showBadge() {
          var name = localStorage.getItem('username');
          if (name) badge.textContent = name;
        }

        function saveUsername() {
          var name = input.value.trim();
          if (!name) return;
          localStorage.setItem('username', name);
          modal.style.display = 'none';
          showBadge();
        }

        if (!localStorage.getItem('username')) {
          modal.style.display = 'flex';
          input.focus();
        }

        saveBtn.addEventListener('click', saveUsername);
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') saveUsername();
        });

        badge.addEventListener('click', function() {
          input.value = localStorage.getItem('username') || '';
          modal.style.display = 'flex';
          input.focus();
          input.select();
        });

        showBadge();
      })();

      // Printer status polling
      (function() {
        if (window._statusPolling) return;
        window._statusPolling = true;

        function checkStatus() {
          fetch('/status')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              var el = document.getElementById('printer-status');
              var text = el.querySelector('.status-text');
              if (data.connected) {
                el.className = 'status-footer connected';
                text.textContent = 'Printer connected';
              } else {
                el.className = 'status-footer disconnected';
                text.textContent = 'Printer not found';
              }
            })
            .catch(function() {
              var el = document.getElementById('printer-status');
              var text = el.querySelector('.status-text');
              el.className = 'status-footer disconnected';
              text.textContent = 'Unable to check status';
            });
        }

        checkStatus();
        setInterval(checkStatus, 5000);
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "App" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="App">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>

    <script type="module">
      import hotwiredTurbo from "https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.12/+esm";
    </script>
  </head>

  <body>
    <div id="starfield" data-turbo-permanent></div>
    <%= yield %>
    <div id="printer-status" class="status-footer">
      <span class="indicator"></span>
      <span class="status-text">Checking...</span>
      <span class="status-sep">·</span>
      <span id="username-badge" class="username-badge"></span>
    </div>

    <div id="username-modal" class="username-modal" style="display:none">
      <div class="username-modal-box">
        <h2>Who are you?</h2>
        <input type="text" id="username-input" placeholder="Your name" maxlength="30" autocomplete="off">
        <button id="username-save" class="btn btn-primary">Save</button>
      </div>
    </div>
    <script>
      // Generate starfield once — persists across Turbo navigations
      (function() {
        var starfield = document.getElementById('starfield');
        if (starfield.children.length > 0) return;
        for (var i = 0; i < 120; i++) {
          var star = document.createElement('div');
          var isCross = Math.random() < 0.15;
          star.className = isCross ? 'star star-cross' : 'star';
          if (!isCross) {
            var size = Math.random() < 0.85 ? 2 : 3;
            star.style.width = size + 'px';
            star.style.height = size + 'px';
          }
          star.style.left = Math.random() * 100 + '%';
          star.style.top = Math.random() * 100 + '%';
          star.style.setProperty('--duration', (1.5 + Math.random() * 3) + 's');
          star.style.setProperty('--delay', (Math.random() * 4) + 's');
          starfield.appendChild(star);
        }
      })();

      // Username prompt
      (function() {
        var modal = document.getElementById('username-modal');
        var input = document.getElementById('username-input');
        var saveBtn = document.getElementById('username-save');
        var badge = document.getElementById('username-badge');

        function showBadge() {
          var name = localStorage.getItem('username');
          if (name) badge.textContent = name;
        }

        function saveUsername() {
          var name = input.value.trim();
          if (!name) return;
          localStorage.setItem('username', name);
          modal.style.display = 'none';
          showBadge();
        }

        if (!localStorage.getItem('username')) {
          modal.style.display = 'flex';
          input.focus();
        }

        saveBtn.addEventListener('click', saveUsername);
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') saveUsername();
        });

        badge.addEventListener('click', function() {
          input.value = localStorage.getItem('username') || '';
          modal.style.display = 'flex';
          input.focus();
          input.select();
        });

        showBadge();
      })();

      // Printer status polling
      (function() {
        if (window._statusPolling) return;
        window._statusPolling = true;

        function checkStatus() {
          fetch('/status')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              var el = document.getElementById('printer-status');
              var text = el.querySelector('.status-text');
              if (data.connected) {
                el.className = 'status-footer connected';
                text.textContent = 'Printer connected';
              } else {
                el.className = 'status-footer disconnected';
                text.textContent = 'Printer not found';
              }
            })
            .catch(function() {
              var el = document.getElementById('printer-status');
              var text = el.querySelector('.status-text');
              el.className = 'status-footer disconnected';
              text.textContent = 'Unable to check status';
            });
        }

        checkStatus();
        setInterval(checkStatus, 5000);
      })();
    </script>
  </body>
</html>
